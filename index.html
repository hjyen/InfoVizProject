<html>
<HEAD>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Choropleth with auto-calculated color (Highmaps)</title>
  <style>
    #container1 { border:0px dotted blue; width: 1000px; height: 500px; margin:0 auto; }
  </style>

    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="datamaps.world.min.js"></script>
<!--     <script src="earthquake.js"></script> -->
    <link rel="stylesheet" type="text/css" href="earthquake.css">
    <link rel="stylesheet" type="text/css" href="index.css">
    

</HEAD>

<body>

<h1>Group Project</h1>
<p style="text-align:center;margin-bottom:40px">SI 649 Group 7</p>
<div id="slidecontainer">
    <input type="range" min="1965" max="2016" value="2016" step="1" class="slider" onchange="showValue(this.value);" />
    <span id="range">2016</span>
</div>


<div id="container1"></div>

<script>
    queue()
        .defer(d3.csv, "database.csv")
        .await(ready);

    function ready(error, data) {
        var eqdata = data;
        var yearPlot = document.getElementById("range").innerHTML;
        // console.log(yearPlot); //get this value from slider

        //radius scale and color scale
        var rScale = d3.scale.linear()
            .domain([5, 9])
            .range([2, 40]);

        //get year of 1965, store index to yearIndex
        var yearIndex = new Array();
        for(var idx in eqdata) {
            var year = "";
            for(i=6; i<10; i++) {
                year = year+eqdata[idx].Date[i];
            }
            if(year == yearPlot) {
                //console.log(year);
                yearIndex.push(idx);
            }
        }

        //create bomb data
        var bombsnew = [];
        var len = yearIndex.length;
        for(var i = 0; i < len; i++) {
            var dateValue=eqdata[yearIndex[i]].Date;
            var date = dateValue[0] + dateValue[1] + "/" + dateValue[3] + dateValue[4] + "/";
            var magnitudeValue = parseFloat(eqdata[yearIndex[i]].Magnitude);
            var colorfillKey;
            if (magnitudeValue <= 6) {
                colorfillKey = 'C1';
            } else if(magnitudeValue <= 7) {
                colorfillKey = 'C2';
            } else if(magnitudeValue <= 8) {
                colorfillKey = 'C3';
            } else {
                colorfillKey = 'C4';
            }
            bombsnew.push({
                name: date+yearPlot + "," +eqdata[yearIndex[i]].Time,
                magnitude: parseFloat(eqdata[yearIndex[i]].Magnitude),
                depth: parseFloat(eqdata[yearIndex[i]].Depth),
                radius: rScale(parseFloat(eqdata[yearIndex[i]].Magnitude)),
                fillKey: colorfillKey,
                latitude: parseFloat(eqdata[yearIndex[i]].Latitude),
                longitude: parseFloat(eqdata[yearIndex[i]].Longitude),
                borderWidth: 0,
                borderColor: '#FFFFFF'
            })
             // console.log(eqdata[i].Magnitude)
        }

        //render map
        var bombMap = new Datamap({
            element: document.getElementById('container1'),
            scope: 'world',
            geographyConfig: {
                popupOnHover: false,
                highlightOnHover: false
            },
            fills: {
                'C1':'#b2d2ff',
                'C2':'#4f9aff',
                'C3':'#006eff',
                'C4':'#0045a3',
                defaultFill: '#e3e5e0'
            },
            data: {
                // 'RUS': {fillKey: 'RUS'},
                // 'USA': {fillKey: 'USA'}
            }
        });

        //draw bubbles for bombs
        bombMap.bubbles(bombsnew, {

            popupTemplate: function (geo, data) {
                    var magnitude = data.magnitude;
                    drawEarthquake(magnitude);
                    return ['<div class="hoverinfo">' +  data.name,
                    '<br/>Magnitude: ' +  data.magnitude + '',
                    '<br/>Depth: ' +  data.depth + '',
                    '</div>'].join('');

            }

        });

        function drawEarthquake(magnitude){
             //place holder : will put into data.magnitude 
            var magnitude = magnitude;
            //
            d3.selectAll("svg.house").remove()
            var width = 1200,
                height = 1200,
                className = "level0";
            levelEarthquake(magnitude);
            // console.log(className);

            var svg = d3.select("body").append("svg")
                  .attr("class", "house")
                  .attr("width", width)
                  .attr("height", height);

            var g = svg.append("g");

            var imgs = g.append("svg:image")
                        .attr("xlink:href", "img/house01.png")
                        .attr("class", className)
                        .attr("x", "60")
                        .attr("y", "60")
                        .attr("width", "300")
                        .attr("height", "300");
            var text = g.append("text")
                        .text('Magnitude:' + magnitude)
                        .style('fill', "white")
                        .attr("x", "80")
                        .attr("y", "80")

            function levelEarthquake(magnitude) {

                if (magnitude < 6) {
                    className = "level1";

                } else if (magnitude >= 6 && magnitude < 6.5) {
                    className = "level2";
                } else if (magnitude >= 6.5 && magnitude < 7) {         
                    className = "level3";
                } else if (magnitude >= 7 && magnitude < 7.5) {
                    className = "level4";
                } else if (magnitude >= 7.5 && magnitude < 8) {
                    className = "level5";
                } else{
                    className = "level6";
                }
                return className;
            }
        }



    }

    function showValue(newValue)
    {   d3.selectAll("svg.datamap").remove()
        document.getElementById("range").innerHTML=newValue;
        queue().defer(d3.csv, 'database.csv').await(ready);
    }



</script>
</div>

</body>
</html>
